// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum CourseField {
  mental_health
  nursing
  psychology
  counseling
  social_work
  other
}

enum CourseStatus {
  planned
  in_progress
  completed
}

enum ComplianceStatus {
  compliant
  non_compliant
  in_progress
}

enum CourseType {
  live_webinar
  in_person
  on_demand
  self_paced
}

enum PlanStatus {
  draft
  active
  completed
  archived
}


model User {
  id                    String   @id @default(uuid())
  email                 String   @unique
  clerkId               String   @unique
  profession            CourseField?
  licenseNumber         String?
  annualCeuRequirement  Int?
  createdAt             DateTime @default(now())

  tracking              UserCeuTracking[]
  compliance            CeuCompliance[]
  planningPreferences   UserPlanningPreferences?
  studyPlans            StudyPlan[]
  completionHistory     CourseCompletionHistory[]
  reviews               CourseReview[]
  reviewHelpfulVotes    ReviewHelpful[]

  @@index([clerkId])
  @@index([email])
}

model CeuProvider {
  id       String  @id @default(uuid())
  name     String
  baseUrl  String
  active   Boolean @default(true)

  courses  CeuCourse[]

  @@index([name])
}

model CeuCourse {
  id                   String      @id @default(uuid())
  providerId           String
  title                String
  url                  String      @unique
  description          String?
  instructors          String?
  price                Decimal?    @db.Decimal(10, 2)
  originalPrice        Decimal?    @db.Decimal(10, 2)
  priceString          String?     // Keep original string for display
  credits              Decimal?    @db.Decimal(5, 2)
  creditsString        String?     // Keep original string for display
  duration             Int?        // Duration in minutes
  durationString       String?     // Keep original string for display
  category             String?
  field                CourseField
  date                 String?
  imageUrl             String?
  courseType           CourseType  @default(on_demand)
  startDate            DateTime?
  endDate              DateTime?
  registrationDeadline DateTime?
  scrapedAt            DateTime    @default(now())
  // Cached rating stats (updated via trigger or service)
  avgRating            Decimal?    @db.Decimal(2, 1)
  reviewCount          Int         @default(0)

  provider    CeuProvider        @relation(fields: [providerId], references: [id])
  tracking    UserCeuTracking[]
  reviews     CourseReview[]

  @@index([providerId])
  @@index([field])
  @@index([category])
  @@index([scrapedAt])
  @@index([url])
  @@index([courseType])
  @@index([startDate])
  @@index([avgRating])
}

model UserCeuTracking {
  id              String       @id @default(uuid())
  userId          String
  courseId        String
  completedDate   DateTime?
  creditsEarned   Float?
  status          CourseStatus @default(planned)
  progressPercent Int          @default(0)
  notes           String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  course        CeuCourse       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  studyPlanItems StudyPlanItem[]

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@index([status])
}

model CeuCompliance {
  id               String           @id @default(uuid())
  userId           String
  year             Int
  requiredCredits  Int
  earnedCredits    Float            @default(0)
  complianceStatus ComplianceStatus @default(in_progress)
  updatedAt        DateTime         @updatedAt

  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, year])
  @@index([userId])
  @@index([year])
}

model UserPlanningPreferences {
  id                   String        @id @default(uuid())
  userId               String        @unique
  budgetMin            Decimal?      @db.Decimal(10, 2)
  budgetMax            Decimal?      @db.Decimal(10, 2)
  preferredFields      CourseField[] @default([])
  preferredCourseTypes CourseType[]  @default([])
  availableDaysPerWeek Int?
  hoursPerSession      Decimal?      @db.Decimal(4, 2)
  preferredTimeSlots   String[]      @default([])
  complianceDeadline   DateTime?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt

  user                 User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model StudyPlan {
  id             String      @id @default(uuid())
  userId         String
  name           String
  targetCredits  Decimal     @db.Decimal(5, 2)
  targetDeadline DateTime
  status         PlanStatus  @default(draft)
  estimatedCost  Decimal?    @db.Decimal(10, 2)
  estimatedHours Decimal?    @db.Decimal(6, 2)
  notes          String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  items          StudyPlanItem[]

  @@index([userId])
  @@index([status])
  @@index([targetDeadline])
}

model StudyPlanItem {
  id            String          @id @default(uuid())
  planId        String
  trackingId    String
  scheduledDate DateTime?
  scheduledTime String?         // e.g., "09:00" or "14:30"
  priority      Int             @default(0)
  notes         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  plan          StudyPlan       @relation(fields: [planId], references: [id], onDelete: Cascade)
  tracking      UserCeuTracking @relation(fields: [trackingId], references: [id], onDelete: Cascade)

  @@unique([planId, trackingId])
  @@index([planId])
  @@index([trackingId])
  @@index([scheduledDate])
}

model CourseCompletionHistory {
  id                String      @id @default(uuid())
  userId            String
  courseId          String
  completedAt       DateTime
  actualDuration    Int?        // Actual time spent in minutes
  rating            Int?        // 1-5 rating
  difficultyRating  Int?        // 1-5 difficulty
  wouldRecommend    Boolean?
  notes             String?
  createdAt         DateTime    @default(now())

  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([courseId])
  @@index([completedAt])
}

model CourseReview {
  id               String      @id @default(uuid())
  userId           String
  courseId         String
  rating           Int         // 1-5 stars
  title            String?     // Optional review title
  content          String?     // Review text
  difficultyRating Int?        // 1-5 difficulty level
  wouldRecommend   Boolean     @default(true)
  isVerified       Boolean     @default(false) // True if user completed the course
  helpfulCount     Int         @default(0)
  isHidden         Boolean     @default(false) // Hidden by admin
  hiddenReason     String?     // Reason for hiding
  hiddenAt         DateTime?   // When it was hidden
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  user             User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  course           CeuCourse   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  helpfulVotes     ReviewHelpful[]

  @@unique([userId, courseId]) // One review per user per course
  @@index([courseId])
  @@index([userId])
  @@index([rating])
  @@index([createdAt])
  @@index([isHidden])
}

model ReviewHelpful {
  id        String   @id @default(uuid())
  reviewId  String
  userId    String
  createdAt DateTime @default(now())

  review    CourseReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([reviewId, userId]) // One vote per user per review
  @@index([reviewId])
  @@index([userId])
}
